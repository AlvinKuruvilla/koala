#!/bin/bash
# Koala Browser Launcher
# Usage: ./koala [options] [path]
#
# Options:
#   --headless, -H    Run in headless mode (CLI only, no GUI)
#   --verbose, -v     Show verbose output (tokens, declarations)
#   --json, -j        Output DOM as JSON
#
# Examples:
#   ./koala                        # Open browser without loading a page
#   ./koala res/simple.html        # Print debug info then open browser
#   ./koala -H res/simple.html     # Headless: print debug info only
#   ./koala -H -v res/simple.html  # Headless with verbose output

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# Parse arguments
HEADLESS=false
CLI_ARGS=""
FILE_PATH=""
BROWSER_ARGS=""

for arg in "$@"; do
    case "$arg" in
        --headless|-H)
            HEADLESS=true
            ;;
        --verbose|-v)
            CLI_ARGS="$CLI_ARGS --verbose"
            ;;
        --json|-j)
            CLI_ARGS="$CLI_ARGS --json"
            ;;
        -*)
            # Other flags pass through
            CLI_ARGS="$CLI_ARGS $arg"
            BROWSER_ARGS="$BROWSER_ARGS $arg"
            ;;
        *)
            if [ -z "$FILE_PATH" ]; then
                FILE_PATH="$arg"
            fi
            ;;
    esac
done

# Build Rust library (release mode for speed)
echo "Building Rust parser..." >&2
cargo build --release --quiet

# If headless, only run CLI
if [ "$HEADLESS" = true ]; then
    if [ -z "$FILE_PATH" ]; then
        echo "Error: headless mode requires a file path" >&2
        exit 1
    fi
    # Run CLI with CSS output by default
    if [ -z "$CLI_ARGS" ]; then
        CLI_ARGS="--css"
    fi
    exec target/release/koala "$FILE_PATH" $CLI_ARGS
fi

# Build Swift browser (only if not headless)
echo "Building browser..." >&2
cd KoalaBrowser
swift build --quiet 2>/dev/null || swift build
cd "$SCRIPT_DIR"

# If a file path is provided, run CLI to print debug info
if [ -n "$FILE_PATH" ]; then
    echo "" >&2
    # Run the Rust CLI to show HTML, CSS, and DOM with styles
    target/release/koala "$FILE_PATH" --css
    echo ""
fi

# Launch the browser
echo "Opening browser..." >&2
exec KoalaBrowser/.build/arm64-apple-macosx/debug/KoalaBrowser $FILE_PATH $BROWSER_ARGS
