#!/bin/bash
# Koala Browser Launcher
# Usage: ./koala [options] [path]
#
# Options:
#   --headless, -H     Run in headless mode (CLI only, no GUI)
#   --screenshot, -S   Take a screenshot (headless render to PNG)
#   --output, -o FILE  Screenshot output path (default: screenshot.png)
#   --width, -W PX     Screenshot width (default: 800)
#   --height PX        Screenshot height (default: 600)
#   --verbose, -v      Show verbose output (tokens, declarations)
#   --json, -j         Output DOM as JSON
#   --no-color         Disable colored output
#
# Examples:
#   ./koala                           # Open browser
#   ./koala res/simple.html           # Open browser with file
#   ./koala -H res/simple.html        # Headless: CLI only
#   ./koala -S res/simple.html        # Screenshot to screenshot.png
#   ./koala -S -o out.png res/simple.html -W 1024

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

# Parse arguments
HEADLESS=false
SCREENSHOT=false
CLI_ARGS=""
FILE_PATH=""
BROWSER_ARGS=""
SCREENSHOT_ARGS=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --headless|-H)
            HEADLESS=true
            shift
            ;;
        --screenshot|-S)
            SCREENSHOT=true
            HEADLESS=true
            shift
            ;;
        --output|-o)
            SCREENSHOT_ARGS="$SCREENSHOT_ARGS -o $2"
            shift 2
            ;;
        --width|-W)
            SCREENSHOT_ARGS="$SCREENSHOT_ARGS -w $2"
            shift 2
            ;;
        --height)
            SCREENSHOT_ARGS="$SCREENSHOT_ARGS -h $2"
            shift 2
            ;;
        --verbose|-v)
            CLI_ARGS="$CLI_ARGS --verbose"
            shift
            ;;
        --json|-j)
            CLI_ARGS="$CLI_ARGS --json"
            shift
            ;;
        --no-color)
            CLI_ARGS="$CLI_ARGS --no-color"
            shift
            ;;
        -*)
            CLI_ARGS="$CLI_ARGS $1"
            BROWSER_ARGS="$BROWSER_ARGS $1"
            shift
            ;;
        *)
            if [ -z "$FILE_PATH" ]; then
                FILE_PATH="$1"
            fi
            shift
            ;;
    esac
done

# Build Rust library (release mode for speed)
echo "Building Rust parser..." >&2
cargo build --release --quiet

# Screenshot mode
if [ "$SCREENSHOT" = true ]; then
    if [ -z "$FILE_PATH" ]; then
        echo "Error: screenshot mode requires a file path" >&2
        exit 1
    fi

    # Build Swift tools
    echo "Building screenshot tool..." >&2
    cd KoalaBrowser
    swift build --quiet 2>/dev/null || swift build
    cd "$SCRIPT_DIR"

    # Run CLI first for debug output
    target/release/koala "$FILE_PATH" --css

    echo "" >&2
    # Take screenshot
    exec KoalaBrowser/.build/arm64-apple-macosx/debug/koala-screenshot "$FILE_PATH" $SCREENSHOT_ARGS
fi

# Headless CLI mode
if [ "$HEADLESS" = true ]; then
    if [ -z "$FILE_PATH" ]; then
        echo "Error: headless mode requires a file path" >&2
        exit 1
    fi
    # Run CLI with CSS output by default
    if [ -z "$CLI_ARGS" ]; then
        CLI_ARGS="--css"
    fi
    exec target/release/koala "$FILE_PATH" $CLI_ARGS
fi

# Build Swift browser (only if not headless)
echo "Building browser..." >&2
cd KoalaBrowser
swift build --quiet 2>/dev/null || swift build
cd "$SCRIPT_DIR"

# If a file path is provided, run CLI to print debug info
if [ -n "$FILE_PATH" ]; then
    echo "" >&2
    # Run the Rust CLI to show HTML, CSS, and DOM with styles
    target/release/koala "$FILE_PATH" --css
    echo ""
fi

# Launch the browser
echo "Opening browser..." >&2
exec KoalaBrowser/.build/arm64-apple-macosx/debug/KoalaBrowser $FILE_PATH $BROWSER_ARGS
